window.domain=window.domain||{},domain.level=domain.level||{},domain.level.EvalResultProcessor=function(){"use strict";var t=function(t,e,n){this.trashBox=t,this.fusionBox=e,this.exitQueue=n},e=t.prototype;return e.process=function(t){var e=[],n=this;return t.goTrash.forEach(function(t){e.push(n.trashBox.take(t))}),t.goQueue.forEach(function(){e.push(n.exitQueue.take(cell))}),t.goFusion.forEach(function(t){e.push(n.fusionBox.take(t).then(function(t){return n.exitQueue.take(t)}))}),Promise.all(e)},t}(),window.domain=window.domain||{},domain.level=domain.level||{},domain.level.ExitQueue=function(){"use strict";var t=4,e=function(e){this.metrics=e,this.queue=[],this.queueMax=t},n=e.prototype;return n.take=function(t){var e=this;return this.goForward().then(function(){return e.involve(t)}).then(function(){return t.locate()})},n.goForward=function(){var t=Promise.resolve();return this.queue.forEach(function(e){t=t.then(function(){return e.x+=1,e.locate(),wait(40)})}),t},n.involve=function(t){if(this.queue.push(t),this.queue.length>this.queueMax){var e=this.queue.shift();e.remove()}return t.x=0,t.y=0,t.setMetrics(this.metrics.left,this.metrics.top,this.metrics.unit),t.setTransitionDuration(600)},n.reset=function(){this.queue=[]},e}(),window.domain=window.domain||{},domain.level=domain.level||{},domain.level.FusionBox=function(){"use strict";var t=function(t){this.metrics=t},e=t.prototype;return e.take=function(t){var e=this;return this.getToReactor(t).then(function(){return e.fusion(t)})},e.getToReactor=function(t){var e=1e3;return t.left.$dom.animation("get-to-reactor-left "+e+"ms"),t.right.$dom.animation("get-to-reactor-right "+e+"ms"),wait(e).then(function(){t.left.remove(),t.right.remove()})},e.fusion=function(t){var e=600,n=new domain.level.Wanderer(0,0,t.left.gender,this.metrics.left,this.metrics.top,this.metrics.unit);return n.locate(),n.$dom.prependTo("#main"),n.$dom.animation("bom-born "+e+"ms"),wait(e).then(function(){return n})},t}(),window.domain=window.domain||{},domain.level=domain.level||{},domain.level.TrashBox=function(){"use strict";var t=function(t){this.metrics=t},e=t.prototype;return e.take=function(t){var e=1e3,n=800;return t.setMetrics(this.metrics.left,this.metrics.top,this.metrics.unit),t.setTransitionDuration(e),wait(10).then(function(){return t.locate(),wait(e)}).then(function(){return t.$dom.animation("go-to-trash "+n+"ms"),wait(n)}).then(function(){return t.remove()})},t}(),function(t,e){"use strict";e.fn.arrowkeys=function(){var t=this;return this._arrowkeysHandler=function(e){switch(e.keyCode){case 37:e.preventDefault(),t.trigger("leftkey");break;case 38:e.preventDefault(),t.trigger("upkey");break;case 39:e.preventDefault(),t.trigger("rightkey");break;case 40:e.preventDefault(),t.trigger("downkey")}},this.on("keydown",this._arrowkeysHandler),this},e.fn.arrowkeysUnbind=function(){return this.off("keydown",this._arrowkeysHandler),delete this._arrowkeysHandler,this}}(window,window.$),this.SwipeEvent=function(t,e){"use strict";var n={SWIPE:{CANCEL:"swipecancel",END:"swipeend"}},i=function(t){t=t||{},this.elm=t.elm,this.fingerCount=0,this.touchCurrent=null,this.touchInitial=null,this.bindEvents()};i.isTouchDevice=function(){return"ontouchstart"in t.document.documentElement};var o=i.prototype;return o.dispatchEvent=function(t){this.elm.dispatchEvent(new CustomEvent(t,{detail:{startX:this.touchInitial.pageX,startY:this.touchInitial.pageY,endX:this.touchCurrent.pageX,endY:this.touchCurrent.pageY}}))},o.swipeEnd=function(){return 1!==this.fingerCount?void(this.fingerCount=0):(this.fingerCount=0,void this.dispatchEvent(n.SWIPE.END))},o.touchStart=function(t){this.touchInitial={pageX:t.pageX,pageY:t.pageY},this.touchCurrent=t,this.fingerCount=1},o.touchMove=function(t){this.touchCurrent=t},o.touchEnd=function(){this.swipeEnd()},o.touchCancel=function(){this.fingerCount>0&&(this.fingerCount=0,this.dispatchEvent(n.SWIPE.CANCEL))},o.createHandlers=function(){var t=this;this.handlers={touchStart:function(e){e.preventDefault(),1===e.touches.length?t.touchStart(e.touches[0]):t.touchCancel()},touchMove:function(e){e.preventDefault(),1===t.fingerCount?t.touchMove(e.touches[0]):t.touchCancel()},touchEnd:function(e){e.preventDefault(),1===t.fingerCount?t.touchEnd():t.touchCancel()},touchCancel:function(e){e.preventDefault(),t.touchCancel()},mouseDown:function(e){e.preventDefault(),t.touchStart(e)},mouseMove:function(e){e.preventDefault(),t.touchMove(e)},mouseUp:function(e){e.preventDefault(),t.touchEnd()},mouseOut:function(e){e.preventDefault(),t.touchCancel()}}},o.bindEvents=function(){this.createHandlers(),i.isTouchDevice()?(this.elm.addEventListener("touchstart",this.handlers.touchStart,!1),this.elm.addEventListener("touchmove",this.handlers.touchMove,!1),this.elm.addEventListener("touchend",this.handlers.touchEnd,!1),this.elm.addEventListener("touchcancel",this.handlers.touchCancel,!1)):(this.elm.addEventListener("mousedown",this.handlers.mouseDown,!1),this.elm.addEventListener("mousemove",this.handlers.mouseMove,!1),this.elm.addEventListener("mouseout",this.handlers.mouseOut,!1),this.elm.addEventListener("mouseup",this.handlers.mouseUp,!1))},o.unbindEvents=function(){i.isTouchDevice()?(this.elm.removeEventListener("touchstart",this.handlers.touchStart,!1),this.elm.removeEventListener("touchmove",this.handlers.touchMove,!1),this.elm.removeEventListener("touchend",this.handlers.touchEnd,!1),this.elm.removeEventListener("touchcancel",this.handlers.touchCancel,!1)):(this.elm.removeEventListener("mousedown",this.handlers.mouseDown,!1),this.elm.removeEventListener("mousemove",this.handlers.mouseMove,!1),this.elm.removeEventListener("mouseout",this.handlers.mouseOut,!1),this.elm.removeEventListener("mouseup",this.handlers.mouseUp,!1))},null!=e&&null!=e.fn&&(e.fn.swipeEvent=function(){return this._swipeEvent=new i({elm:this[0]}),this},e.fn.swipeEventUnbind=function(){return null!=this._swipeEvent&&this._swipeEvent.unbindEvents(),this._swipeEvent=null,this}),i}(window,window.$),window.SwipeEvent.SwipeCross=function(t,e){"use strict";var n={THRESHOLD:3},i={UP:0,DOWN:1,RIGHT:2,LEFT:3},o={SWIPE:{UP:"swipeup",RIGHT:"swiperight",DOWN:"swipedown",LEFT:"swipeleft"}},s=function(t){t=t||{},this.elm=t.elm,this.bindEvents()},r=s.prototype;r.createHandlers=function(){var t=this;this.handler=function(e){e.preventDefault();var s=new u(e.detail.startX,e.detail.startY,e.detail.endX,e.detail.endY);if(!(s.distance()<=n.THRESHOLD)){var r=s.direction();t.dispatchEvent(r===i.UP?o.SWIPE.UP:r===i.LEFT?o.SWIPE.LEFT:r===i.RIGHT?o.SWIPE.RIGHT:o.SWIPE.DOWN)}}},r.bindEvents=function(){this.createHandlers(),this.elm.addEventListener("swipeend",this.handler,!1)},r.unbindEvents=function(){this.elm.removeEventListener("swipeend",this.handler,!1)},r.dispatchEvent=function(t){this.elm.dispatchEvent(new CustomEvent(t,{}))};var u=function(t,e,n,i){this.startX=t,this.startY=e,this.endX=n,this.endY=i},h=u.prototype;return h.distance=function(){var t=this.endX-this.startX,e=this.endY-this.startY;return Math.max(Math.abs(t),Math.abs(e))},h.angle=function(){var t=Math.atan2(this.endY-this.startY,this.endX-this.startX);return(Math.floor(180*t/Math.PI)+360)%360},h.direction=function(){var t=this.angle();return 45>t||t>=315?i.RIGHT:t>=45&&135>t?i.DOWN:t>=135&&225>t?i.LEFT:i.UP},null!=e&&null!=e.fn&&(e.fn.swipeCross=function(){return null==this._swipeEvent&&(this._swipeEvent=new t.SwipeEvent({elm:this[0]})),this._swipeCross=new s({elm:this[0]}),this},e.fn.swipeCrossUnbind=function(){return null!=this._swipeEvent&&(this._swipeEvent.unbindEvents(),this._swipeEvent=null),null!=this._swipeCross&&this._swipeCross.unbindEvents(),this._swipeCross=null,this}),s}(window,window.$),window.pages=window.pages||{},pages.level={},pages.level.PhaseController=function(){"use strict";var t=180,e=70,n=3,i=80,o=50,s=2,r=function(){var r=new pages.level.Positioner(t,e,n).metrics(),u=new pages.level.Positioner(i,o,s).metrics(),h={left:0,top:0,unit:1},a=new pages.level.Positioner(i,10,1).metrics(),c=new pages.level.Positioner(i-50,10,1).metrics();this.map=new domain.level.Map(r),this.field=new domain.level.Field(r),this.evalBox=new domain.level.EvalBox(u),this.trashBox=new domain.level.TrashBox(h),this.fusionBox=new domain.level.FusionBox(a),this.exitQueue=new domain.level.ExitQueue(c),this.ball=new domain.level.Ball(r),this.pointBox=debug.PointBox,this.scoreBox=debug.ScoreBox,this.menuButton=$(".menu-button").menuButton($("#level-menu"))},u=r.prototype;return u.init=function(t){var e=this;this.map.loadFromBomList(t.boms),Promise.resolve().then(function(){return pages.common.BackgroundService.turnWhite()}).then(function(){return e.field.appear()}).then(function(){return e.ball.appear()}).then(function(){return e.map.appear("#main")}).then(function(){return e.menuButton.show()});var n=new domain.level.BallMoveMobLeaveService(this.ball,this.map,this.evalBox),i=new domain.level.EvalResultProcessor(this.trashBox,this.fusionBox,this.exitQueue),o=function(t){null!=t&&(e.scoreBox.add(t.score),e.pointBox.countUp(t.left.gender,t.right.gender),i.process(t))},s=function(){n.up().then(o)},r=function(){n.down().then(o)},u=function(){n.left().then(o)},h=function(){n.right().then(o)};bindEvents(s,r,u,h,this.reset.bind(this))},u.loadCurrentLevel=function(){var t=(window.location.hash.substring(1)||0)+".json";return this.getLevel(t)},u.cease=function(){var t=this;return this.menuButton.hide(),Promise.resolve().then(function(){return t.ball.disappear()}).then(function(){return domain.level.Wanderer.disappear()}).then(function(){return t.field.disappear()}).then(function(){return pages.common.BackgroundService.turnBlack()})},u.reset=function(){var t=this;this.cease().then(function(){return t.map.empty(),t.pointBox.reset(),t.evalBox.reset(),t.scoreBox.reset(),t.exitQueue.reset(),wait(300)}).then(function(){return t.loadCurrentLevel()}).then(function(e){t.init(e)})},u.getLevel=function(t){return Promise.resolve($.getJSON("level/"+t))},u.goBackToMap=function(){return this.cease().then(function(){window.history.back()})},u.onMoveSuccess=function(){},u.onMoveFailure=function(){},r}(),pages.level.Positioner=function(){var t=function(t,e,n){this.top=t,this.fwp=e,this.m=n,this.calc()},e=t.prototype;return e.calc=function(){this.width=$(window).width(),this.height=$(window).height();var t=Math.min(this.width,this.height-this.top);this.fieldWidth=t*this.fwp/100,this.LEFT=Math.floor((this.width-this.fieldWidth)/2),this.TOP=this.top,this.UNIT=Math.floor(this.fieldWidth/this.m)},e.metrics=function(){return{top:this.TOP,left:this.LEFT,unit:this.UNIT,width:this.UNIT*this.m}},t}(),window.debug=window.debug||{},debug.PointBox={reset:function(){},getCount:function(t,e){return parseInt(this.getTarget(t,e).text())},setCount:function(t,e,n){this.getTarget(t,e).text(n)},countUp:function(t,e){this.setCount(t,e,this.getCount(t,e)+1)},reset:function(){this.setCount("f","f",0),this.setCount("m","f",0),this.setCount("f","m",0),this.setCount("m","m",0)},getTarget:function(t,e){var n=t+e;return $(".point ."+n)}},window.debug=window.debug||{},debug.ScoreBox={add:function(t){this.setScore(this.getScore()+t)},getScore:function(){return parseInt(this.getTarget().text())},setScore:function(t){this.getTarget().text(t)},reset:function(){this.setScore(0)},getTarget:function(){return $(".point .level-score")}};