window.domain=window.domain||{},domain.level=domain.level||{},domain.level.Ball=function(t){"use strict";var e=function(e){this.transDur=800,this.x=1,this.y=1,this.MAX=3,this.$dom=t(".circle").css({width:e.unit+"px",height:e.unit+"px"}),this.metrics=e,this.locate()},i=e.prototype;return i.appear=function(){return console.log("ball appear"),this.$dom.css("visibility","visible"),this.$dom.anim("ball-appear",this.transDur)},i.disappear=function(){var t=this;return t.$dom.css("visibility","hidden"),this.$dom.anim("ball-disappear",400)},i.up=function(){this.setPos(this.posAhead("up"))},i.down=function(){this.setPos(this.posAhead("down"))},i.left=function(){this.setPos(this.posAhead("left"))},i.right=function(){this.setPos(this.posAhead("right"))},i.pos=function(){return{x:this.x,y:this.y}},i.posAhead=function(t){switch(t){case"up":return this.relativePos(0,-1);case"down":return this.relativePos(0,1);case"left":return this.relativePos(-1,0);case"right":return this.relativePos(1,0)}},i.relativePos=function(t,e){return{x:(this.x+t+this.MAX)%this.MAX,y:(this.y+e+this.MAX)%this.MAX}},i.setPos=function(t){this.x=t.x,this.y=t.y,this.locate()},i.locate=function(){this.$dom.css("top",this.metrics.top+this.y*this.metrics.unit+"px"),this.$dom.css("left",this.metrics.left+this.x*this.metrics.unit+"px")},i.refuseToMove=function(t){return this.$dom.animation("up"===t||"down"===t?"ball-refuse-y 300ms":"ball-refuse-x 300ms"),wait(window.NUDUR)},e}(window.jQuery),window.domain=window.domain||{},domain.level=domain.level||{},domain.level.BallMoveMobLeaveService=function(){"use strict";var t=function(t,e,n){this.ball=t,this.mobs=new i(e),this.box=n},e=t.prototype;e.move=function(t){var e=this.ball.posAhead(t);if(null==this.mobs.find(e))return this.ball.refuseToMove(t),Promise.reject();this.ball[t]();var i=this.mobs.leave(e);return this.box.take(i)},e.up=function(){return this.move("up")},e.down=function(){return this.move("down")},e.right=function(){return this.move("right")},e.left=function(){return this.move("left")};var i=function(t){this.wanderers=t},n=i.prototype;return n.leave=function(t){var e=this.wanderers.select(t);return this.wanderers.filter(e),e=e[0],this.wanderers.selectRange(t).forEach(function(t){t.up()}),e},n.find=function(t){return this.wanderers.find(t)},t}(),NUDUR=300,window.domain=window.domain||{},domain.level=domain.level||{},domain.level.EvalBox=function(){"use strict";var t=function(t){this.metrics=t},e=t.prototype;e.take=function(t){if(null==this.leftPromise)return this.leftPromise=this.setToLeft(t),Promise.resolve(null);var e=this.leftPromise;return delete this.leftPromise,this.setToRight(t).then(function(t){return e.then(function(e){return i(e,t)})})};var i=function(t,e){var i={left:t,right:e};return i.goTrash=[],i.goFusion=[],i.goQueue=[],t.gender===e.gender?(i.score=10,i.goTrash.push(e),i.goTrash.push(t)):(i.score=100,i.goFusion.push({left:t,right:e})),i};return e.involve=function(t){t.setMetrics(this.metrics.left,this.metrics.top,this.metrics.unit)},e.setToLeft=function(t){var e=800;return this.involve(t),t.setTransitionDuration(e),t.x=0,t.y=0,wait(10).then(function(){return t.locate(),wait(e)}).then(function(){return t})},e.setToRight=function(t){var e=800;return this.involve(t),t.setTransitionDuration(e),wait(10).then(function(){return t.x=1,t.y=0,t.locate(),wait(e)}).then(function(){return t})},e.reset=function(){null!=this.left&&this.left.remove(),null!=this.right&&this.right.remove(),this.left=null,this.right=null},t}(),window.domain=window.domain||{},domain.level=domain.level||{},domain.level.EvalResultProcessor=function(){"use strict";var t=function(t,e,i){this.trashBox=t,this.fusionBox=e,this.exitQueue=i},e=t.prototype;return e.process=function(t){var e=[],i=this;return t.goTrash.forEach(function(t){e.push(i.trashBox.take(t))}),t.goQueue.forEach(function(t){e.push(i.exitQueue.take(t))}),t.goFusion.forEach(function(t){e.push(i.fusionBox.take(t).then(function(t){return i.exitQueue.take(t)}))}),Promise.all(e)},t}(),window.domain=window.domain||{},domain.level=domain.level||{},domain.level.ExitQueue=function(){"use strict";var t=4,e=function(e){this.metrics=e,this.queue=[],this.queueMax=t},i=e.prototype;return i.take=function(t){var e=this;return this.goForward().then(function(){return e.involve(t)}).then(function(){return t.locate()})},i.goForward=function(){var t=Promise.resolve();return this.queue.forEach(function(e){t=t.then(function(){return e.x+=1,e.locate(),wait(40)})}),t},i.involve=function(t){if(this.queue.push(t),this.queue.length>this.queueMax){var e=this.queue.shift();e.remove()}return t.x=0,t.y=0,t.setMetrics(this.metrics.left,this.metrics.top,this.metrics.unit),t.setTransitionDuration(600)},i.reset=function(){this.queue=[]},e}(),window.domain=window.domain||{},domain.level=domain.level||{},domain.level.Field=function(){"use strict";var t=200,e=function(e){var i=6;this.left=e.left-i,this.top=e.top-i,this.unit=e.unit,this.width=e.width+2*i,this.dur=t},i=e.prototype;return i.appear=function(){var t=this;return loadImage("images/field.svg","field-grid",document.body).then(function(e){return t.$dom=e,e.css("left",t.left+"px"),e.css("top",t.top+"px"),e.css("width",t.width+"px"),e.anim("field-appear",t.dur)})},i.disappear=function(){var t=this;return this.$dom.anim("field-disappear",400).then(function(){t.$dom.remove()})},e}(),window.domain=window.domain||{},domain.level=domain.level||{},domain.level.FusionBox=function(){"use strict";var t=function(t){this.metrics=t},e=t.prototype;return e.take=function(t){var e=this;return this.getToReactor(t).then(function(){return e.fusion(t)})},e.getToReactor=function(t){var e=1e3;return t.left.$dom.animation("get-to-reactor-left "+e+"ms"),t.right.$dom.animation("get-to-reactor-right "+e+"ms"),wait(e).then(function(){t.left.remove(),t.right.remove()})},e.fusion=function(t){var e=600,i=new domain.level.Wanderer(0,0,t.left.gender,this.metrics.left,this.metrics.top,this.metrics.unit);return i.locate(),i.$dom.prependTo("#main"),i.$dom.animation("bom-born "+e+"ms"),wait(e).then(function(){return i})},t}(),window.domain=window.domain||{},domain.level=domain.level||{},domain.level.Map=function(t){"use strict";var e=function(e){this.cells=[],this.$dom=t(document.body),this.top=e.top,this.left=e.left,this.unit=e.unit};e.createFromBomList=function(t){return(new e).loadFromBomList(t)};var i=e.prototype;return i.createCellFromBom=function(t){return new domain.level.Wanderer(t.x,t.y,t.gender,this.left,this.top,this.unit)},i.empty=function(){this.cells.forEach(function(t){t.remove()}),this.cells=[]},i.loadFromBomList=function(t){return t.forEach(function(t){this.loadOne(this.createCellFromBom(t))},this),this},i.loadList=function(t){return t.forEach(function(t){this.loadOne(t)},this),this},i.loadOne=function(t){return this.cells.push(t),t.locate(),this},i.appear=function(t){var e=Promise.resolve();return this.cells.forEach(function(i){e=e.then(function(){return i.appear(t),wait(40)})}),e},i.commandAll=function(t,e){this.cells.forEach(function(i){i[t](e)})},i.allUp=function(){this.commandAll("up")},i.allDown=function(){this.commandAll("down")},i.allRight=function(){this.commandAll("right")},i.allLeft=function(){this.commandAll("left")},i.select=function(t){return this.cells.filter(function(e){return e.x===t.x&&e.y===t.y})},i.find=function(t){var e=this.select(t);return 0===e.length?null:e[0]},i.selectRange=function(t){return this.cells.filter(function(e){return e.x===t.x&&e.y>t.y})},i.filter=function(t){this.cells=this.cells.filter(function(e){return t.indexOf(e)<0})},e}(window.jQuery),domain.level.TrashBox=function(){"use strict";var t=function(t){this.metrics=t},e=t.prototype;return e.take=function(t){var e=1e3,i=800;return t.setMetrics(this.metrics.left,this.metrics.top,this.metrics.unit),t.setTransitionDuration(e),wait(10).then(function(){return t.locate(),wait(e)}).then(function(){return t.$dom.animation("go-to-trash "+i+"ms"),wait(i)}).then(function(){return t.remove()})},t}(),window.domain=window.domain||{},domain.level=domain.level||{},domain.level.Wanderer=function(t){"use strict";var e=function(i,n,s,o,r,u){this.x=i,this.y=n,this.width=Math.floor(u/2),this.gutter=Math.floor(u/4),this.$dom=t("<img />").css({position:"absolute",width:this.width+"px",height:this.width+"px"}),this.setTransitionDuration(window.NUDUR),this.setGender(s),this.setMetrics(o,r,u),e.allList.push(this)};e.allList=[],e.disappear=function(){var t=Promise.resolve();return e.allList.forEach(function(e){t=t.then(function(){return e.disappear(),wait(10)})}),t.then(function(){return wait(500)})};var i=e.prototype;return i.setTransitionDuration=function(t){return this.locateDuration=t,this.$dom.css("transition-duration",t+"ms"),wait()},i.setGender=function(t){return this.gender=t,"m"===t?this.setMaleColor():"f"===t?this.setFemaleColor():void 0},i.setFemaleColor=function(){return this.$dom.attr("src","images/neef.svg"),this},i.setMaleColor=function(){return this.$dom.attr("src","images/nim.svg"),this},i.appear=function(t){return this.$dom.prependTo(t||document.body).anim("bom-appear",500)},i.disappear=function(){var t=this;return this.$dom.css("visibility","hidden"),this.$dom.anim("bom-disappear",500).then(function(){t.remove()})},i.setMetrics=function(t,e,i){return this.offsetX=t,this.offsetY=e,this.unit=i,this},i.locate=function(){return this.$dom.css("top",this.offsetY+this.unit*this.y+this.gutter+"px"),this.$dom.css("left",this.offsetX+this.unit*this.x+this.gutter+"px"),wait(this.transitionDuration)},i.remove=function(){this.$dom.remove(),e.allList.splice(e.allList.indexOf(this),1)},i.move=function(t,e){return this.x+=t,this.y+=e,this.locate()},i.up=function(){return this.move(0,-1)},i.down=function(){return this.move(0,1)},i.left=function(){return this.move(-1,0)},i.right=function(){return this.move(1,0)},e}(window.jQuery),scene.level.IntroScene=function(){"use strict";var t=function(t){this.level=t,this.pos=new pages.level.Positioner,this.chr=new domain.common.Ma,this.ball=new domain.level.Ball(this.pos.fieldMetrics())},e=t.prototype=new scene.common.Scene;return e.start=function(){var t=this,e=this.pos.paperPos();this.chr.x=e.left,this.chr.y=800,t.chr.put(),pages.common.BackgroundService.turnWhite(),Promise.resolve().then(function(){return t.chr.moveTo("y",e.top,1e3)}).then(function(){t.chr.disappear()}).then(function(){return t.ball.appear()}).then(function(){return t.finish()})},t}(),window.scene=window.scene||{},scene.level=scene.level||{},scene.level.PlayScene=function(t){"use strict";var e=window._console,i=function(e){var i=e.pos;this.ball=e.ball,this.level=e.level;var n=i.fieldMetrics(),s=i.evalRoomMetrics(),o=i.leftDoorMetrics(),r=i.queueMetrics(),u=i.fusionBoxMetrics();this.map=new domain.level.Map(n),this.field=new domain.level.Field(n),this.evalBox=new domain.level.EvalBox(s),this.trashBox=new domain.level.TrashBox(o),this.fusionBox=new domain.level.FusionBox(u),this.exitQueue=new domain.level.ExitQueue(r),this.pointBox=debug.PointBox,this.scoreBox=debug.ScoreBox,this.menuButton=t(".menu-button").menuButton(t("#level-menu"))},n=i.prototype=new scene.common.Scene;return n.loadLevel=function(){return this.map.loadFromBomList(this.level.boms),this},n.start=function(){var t=this;this.loadLevel();var e=Promise.resolve().then(function(){return t.field.appear()}).then(function(){return t.map.appear("#main")}).then(function(){return t.menuButton.show()}),i=new domain.level.BallMoveMobLeaveService(this.ball,this.map,this.evalBox),n=new domain.level.EvalResultProcessor(this.trashBox,this.fusionBox,this.exitQueue),s=function(e){null!=e&&(t.scoreBox.add(e.score),t.pointBox.countUp(e.left.gender,e.right.gender),n.process(e))},o=function(){i.up().then(s)},r=function(){i.down().then(s)},u=function(){i.left().then(s)},h=function(){i.right().then(s)};return this.bindEvents(o,r,u,h),e},n.cease=function(){var t=this;return this.menuButton.hide(),this.unbindEvents(),this.ball.disappear().then(function(){return domain.level.Wanderer.disappear()}).then(function(){return t.field.disappear()}).then(function(){return pages.common.BackgroundService.turnBlack()}).then(function(){return t.map.empty(),t.pointBox.reset(),t.evalBox.reset(),t.scoreBox.reset(),t.exitQueue.reset(),wait(300)}).then(function(){t.finish()})},n.bindEvents=function(i,n,s,o){this.swipe$dom=t(".wrapper").swipeCross().on("swipeup",function(){e.log("swipeup"),i()}).on("swiperight",function(){e.log("swiperight"),o()}).on("swipeleft",function(){e.log("swipeleft"),s()}).on("swipedown",function(){e.log("swipedown"),n()}).on("swipecancel",function(){e.log("swipecancel")}),t(document).arrowkeys().on("upkey",function(){e.log("upkey"),i()}).on("rightkey",function(){e.log("rightkey"),o()}).on("leftkey",function(){e.log("leftkey"),s()}).on("downkey",function(){e.log("downkey"),n()})},n.unbindEvents=function(){this.swipe$dom.swipeCrossUnbind().off("swipeup").off("swipedown").off("swipeleft").off("swiperight").off("swipecancel"),t(document).arrowkeysUnbind().off("upkey").off("rightkey").off("leftkey").off("downkey")},i}(window.jQuery),window.pages=window.pages||{},pages.level=pages.level||{},pages.level.PhaseController=function(t){"use strict";var e=function(){},i=e.prototype;return i.loadCurrentLevel=function(){var t=(window.location.hash.substring(1)||0)+".json";return this.getLevel(t)},i.getLevel=function(e){return Promise.resolve(t.getJSON("level/"+e))},e}(window.jQuery),pages.level.Positioner=function(t){"use strict";var e=50,i=50,n=1.5,s=function(){this.calc()},o=s.prototype;return o.calcAvailableArea=function(){var n=this.width=t(window).width(),s=this.height=t(window).height();this.availableHeight=s-e-i,this.availableWidth=n},o.calcBestArea=function(){this.calcAvailableArea(),this.availableWidth*n>this.availableHeight?(console.log("height dominant"),this.bestWidth=this.availableHeight/n,this.bestHeight=this.availableHeight):(console.log("width dominant"),this.bestWidth=this.availableWidth,this.bestHeight=this.availableWidth*n)},o.calcLeft=function(){this.left=(this.width-this.bestWidth)/2},o.calc=function(){this.calcBestArea(),this.calcLeft(),this.UNIT=this.bestWidth/4,this.LEFT=this.left+this.UNIT/2,this.TOP=e},o.topUIPosition=function(){return{top:0,left:this.left}},o.gridPosition=function(t,e,i){var n=this.UNIT;return{top:this.TOP+n*e,left:this.LEFT+n*t,unit:n,width:n*i}},o.fieldMetrics=function(){return this.gridPosition(0,2,3)},o.evalRoomMetrics=function(){return this.gridPosition(0,1,2)},o.leftDoorMetrics=function(){return this.gridPosition(0,0,1)},o.rightDoorMetrics=function(){return this.gridPosition(2,1,1)},o.queueMetrics=function(){var t=this.gridPosition(1,0,1);return t.unit/=2,t},o.fusionBoxMetrics=function(){return this.gridPosition(1,1,1)},o.paperPos=function(){return{left:this.width/2,top:this.TOP+4*this.UNIT}},s}(window.jQuery),function(t,e){"use strict";e.fn.arrowkeys=function(){var t=this;return this._arrowkeysHandler=function(e){switch(e.keyCode){case 37:e.preventDefault(),t.trigger("leftkey");break;case 38:e.preventDefault(),t.trigger("upkey");break;case 39:e.preventDefault(),t.trigger("rightkey");break;case 40:e.preventDefault(),t.trigger("downkey")}},this.on("keydown",this._arrowkeysHandler),this},e.fn.arrowkeysUnbind=function(){return this.off("keydown",this._arrowkeysHandler),delete this._arrowkeysHandler,this}}(window,window.$),this.SwipeEvent=function(t,e){"use strict";var i={SWIPE:{CANCEL:"swipecancel",END:"swipeend"}},n=function(t){t=t||{},this.elm=t.elm,this.fingerCount=0,this.touchCurrent=null,this.touchInitial=null,this.bindEvents()};n.isTouchDevice=function(){return"ontouchstart"in t.document.documentElement};var s=n.prototype;return s.dispatchEvent=function(t){this.elm.dispatchEvent(new CustomEvent(t,{detail:{startX:this.touchInitial.pageX,startY:this.touchInitial.pageY,endX:this.touchCurrent.pageX,endY:this.touchCurrent.pageY}}))},s.swipeEnd=function(){return 1!==this.fingerCount?void(this.fingerCount=0):(this.fingerCount=0,void this.dispatchEvent(i.SWIPE.END))},s.touchStart=function(t){this.touchInitial={pageX:t.pageX,pageY:t.pageY},this.touchCurrent=t,this.fingerCount=1},s.touchMove=function(t){this.touchCurrent=t},s.touchEnd=function(){this.swipeEnd()},s.touchCancel=function(){this.fingerCount>0&&(this.fingerCount=0,this.dispatchEvent(i.SWIPE.CANCEL))},s.createHandlers=function(){var t=this;this.handlers={touchStart:function(e){e.preventDefault(),1===e.touches.length?t.touchStart(e.touches[0]):t.touchCancel()},touchMove:function(e){e.preventDefault(),1===t.fingerCount?t.touchMove(e.touches[0]):t.touchCancel()},touchEnd:function(e){e.preventDefault(),1===t.fingerCount?t.touchEnd():t.touchCancel()},touchCancel:function(e){e.preventDefault(),t.touchCancel()},mouseDown:function(e){e.preventDefault(),t.touchStart(e)},mouseMove:function(e){e.preventDefault(),t.touchMove(e)},mouseUp:function(e){e.preventDefault(),t.touchEnd()},mouseOut:function(e){e.preventDefault(),t.touchCancel()}}},s.bindEvents=function(){this.createHandlers(),n.isTouchDevice()?(this.elm.addEventListener("touchstart",this.handlers.touchStart,!1),this.elm.addEventListener("touchmove",this.handlers.touchMove,!1),this.elm.addEventListener("touchend",this.handlers.touchEnd,!1),this.elm.addEventListener("touchcancel",this.handlers.touchCancel,!1)):(this.elm.addEventListener("mousedown",this.handlers.mouseDown,!1),this.elm.addEventListener("mousemove",this.handlers.mouseMove,!1),this.elm.addEventListener("mouseout",this.handlers.mouseOut,!1),this.elm.addEventListener("mouseup",this.handlers.mouseUp,!1))},s.unbindEvents=function(){n.isTouchDevice()?(this.elm.removeEventListener("touchstart",this.handlers.touchStart,!1),this.elm.removeEventListener("touchmove",this.handlers.touchMove,!1),this.elm.removeEventListener("touchend",this.handlers.touchEnd,!1),this.elm.removeEventListener("touchcancel",this.handlers.touchCancel,!1)):(this.elm.removeEventListener("mousedown",this.handlers.mouseDown,!1),this.elm.removeEventListener("mousemove",this.handlers.mouseMove,!1),this.elm.removeEventListener("mouseout",this.handlers.mouseOut,!1),this.elm.removeEventListener("mouseup",this.handlers.mouseUp,!1))},null!=e&&null!=e.fn&&(e.fn.swipeEvent=function(){return this._swipeEvent=new n({elm:this[0]}),this},e.fn.swipeEventUnbind=function(){return null!=this._swipeEvent&&this._swipeEvent.unbindEvents(),this._swipeEvent=null,this}),n}(window,window.$),window.SwipeEvent.SwipeCross=function(t,e){"use strict";var i={THRESHOLD:3},n={UP:0,DOWN:1,RIGHT:2,LEFT:3},s={SWIPE:{UP:"swipeup",RIGHT:"swiperight",DOWN:"swipedown",LEFT:"swipeleft"}},o=function(t){t=t||{},this.elm=t.elm,this.bindEvents()},r=o.prototype;r.createHandlers=function(){var t=this;this.handler=function(e){e.preventDefault();var o=new u(e.detail.startX,e.detail.startY,e.detail.endX,e.detail.endY);if(!(o.distance()<=i.THRESHOLD)){var r=o.direction();t.dispatchEvent(r===n.UP?s.SWIPE.UP:r===n.LEFT?s.SWIPE.LEFT:r===n.RIGHT?s.SWIPE.RIGHT:s.SWIPE.DOWN)}}},r.bindEvents=function(){this.createHandlers(),this.elm.addEventListener("swipeend",this.handler,!1)},r.unbindEvents=function(){this.elm.removeEventListener("swipeend",this.handler,!1)},r.dispatchEvent=function(t){this.elm.dispatchEvent(new CustomEvent(t,{}))};var u=function(t,e,i,n){this.startX=t,this.startY=e,this.endX=i,this.endY=n},h=u.prototype;return h.distance=function(){var t=this.endX-this.startX,e=this.endY-this.startY;return Math.max(Math.abs(t),Math.abs(e))},h.angle=function(){var t=Math.atan2(this.endY-this.startY,this.endX-this.startX);return(Math.floor(180*t/Math.PI)+360)%360},h.direction=function(){var t=this.angle();return 45>t||t>=315?n.RIGHT:t>=45&&135>t?n.DOWN:t>=135&&225>t?n.LEFT:n.UP},null!=e&&null!=e.fn&&(e.fn.swipeCross=function(){return null==this._swipeEvent&&(this._swipeEvent=new t.SwipeEvent({elm:this[0]})),this._swipeCross=new o({elm:this[0]}),this},e.fn.swipeCrossUnbind=function(){return null!=this._swipeEvent&&(this._swipeEvent.unbindEvents(),this._swipeEvent=null),null!=this._swipeCross&&this._swipeCross.unbindEvents(),this._swipeCross=null,this}),o}(window,window.$),window.debug=window.debug||{},debug.PointBox={getCount:function(t,e){"use strict";return parseInt(this.getTarget(t,e).text())},setCount:function(t,e,i){"use strict";this.getTarget(t,e).text(i)},countUp:function(t,e){"use strict";this.setCount(t,e,this.getCount(t,e)+1)},reset:function(){"use strict";this.setCount("f","f",0),this.setCount("m","f",0),this.setCount("f","m",0),this.setCount("m","m",0)},getTarget:function(t,e){"use strict";var i=t+e;return $(".point ."+i)}},window.debug=window.debug||{},debug.ScoreBox={add:function(t){"use strict";this.setScore(this.getScore()+t)},getScore:function(){"use strict";return parseInt(this.getTarget().text())},setScore:function(t){"use strict";this.getTarget().text(t)},reset:function(){"use strict";this.setScore(0)},getTarget:function(){"use strict";return $(".point .level-score")}};