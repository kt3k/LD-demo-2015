<html>
<head>
<title>LD-main</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="./stylesheets/all.css" />

<script>window.config = {}</script>
<script src="./javascripts/common.js"></script>
<script src="./javascripts/level.js"></script>

</head>
<body>
<style>

* {
    margin: 0;
    padding: 0;
}

body {
    position: relative;
    background-color: #C1C6CB;
}

#main {
    position: absolute;
    width: 100%;
    height: 100%;
    overflow: hidden;
}

.circle {
    position: absolute;
    visibility: hidden;
    transition-duration: 300ms;
}

.field-grid {
    position: absolute;
    z-index: -1;
}

@-webkit-keyframes ball-appear {
    0% { opacity: 0; transform: scale(2); }
}

@-webkit-keyframes ball-refuse-x {
    50% { transform: scale(2, 0.5); opacity: 0.2; }
}

@-webkit-keyframes ball-refuse-y {
    50% { transform: scale(0.5, 2); opacity: 0.2; }
}

@-webkit-keyframes bom-appear {
    0% { opacity: 0; transform: translate(0, 10px); }
}

@-webkit-keyframes go-to-trash {
    100% { opacity: 0; transform: translate(0, 10px) scale(0); }
}

@-webkit-keyframes get-to-reactor-left {
    0% { opacity: 1; transform: translate(0, 0) rotate(0) scale(1); }
    50% { opacity: 1; transform: translate(20px, 0) rotate(0) scale(1); }
    100% { opacity: 0; transform: translate(40px, 0) rotate(360deg) scale(0); }
}

@-webkit-keyframes get-to-reactor-right {
    0% { opacity: 1; transform: translate(0, 0) rotate(0) scale(1); }
    50% { opacity: 1; transform: translate(-20px, 0) rotate(0) scale(1); }
    100% { opacity: 0; transform: translate(-40px, 0) rotate(-360deg) scale(0); }
}


.wrapper {
    position: absolute;
    height: 85%;
    width: 100%;
    left: 0px;
    top: 15%;
}

</style>

<script>


var NUDUR = 300;
var SUDUR = NUDUR + 'ms';

var UDUR = NUDUR + 'ms';

var lpc;


// main
$(function () {
    lpc = new pages.level.PhaseController();

    lpc.loadCurrentLevel().then(function (level) {
        lpc.init(level);
    });
});


// Domain layer
window.domain = window.domain || {};
domain.level = domain.level || {};
domain.level.BallMoveMobLeaveService = (function () {
    'use strict';

    var exports = function (ball, wanderers, box) {
        this.ball = ball;
        this.mobs = new Mobs(wanderers);
        this.box = box;
    };

    var bmsPrototype = exports.prototype;

    bmsPrototype.move = function (dir) {

        // position interface
        // pos.x x-coordinate
        // pos.y y-coordinate
        var pos = this.ball.posAhead(dir);

        if (this.mobs.find(pos) == null) {

            this.ball.refuseToMove(dir);

            return Promise.reject();
        }

        this.ball[dir]();

        var w = this.mobs.leave(pos);

        return this.box.take(w);
    };

    bmsPrototype.up = function () { return this.move('up'); };
    bmsPrototype.down = function () { return this.move('down'); };
    bmsPrototype.right = function () { return this.move('right'); };
    bmsPrototype.left = function () { return this.move('left'); };

    // `Mobs` role (extends Map)
    var Mobs = function (wanderers) {
        this.wanderers = wanderers;
    };

    var mobsPrototype = Mobs.prototype;

    mobsPrototype.leave = function (pos) {
        var w = this.wanderers.select(pos);
        this.wanderers.filter(w);

        w = w[0];

        this.wanderers.selectRange(pos).forEach(function (cell) {
            cell.up();
        });

        return w;
    };

    mobsPrototype.find = function (pos) {
        return this.wanderers.find(pos);
    };

    return exports;

}());


// The box above the grid
window.domain = window.domain || {};
domain.level = domain.level || {};
domain.level.EvalBox = (function () {
    'use strict';

    var exports = function (metrics) {
        this.metrics = metrics;
    };

    var boxPrototype = exports.prototype;

    boxPrototype.take = function (wanderer) {

        if (this.leftPromise == null) {

            this.leftPromise = this.setToLeft(wanderer);

            return Promise.resolve(null);
        };

        var leftPromise = this.leftPromise;
        delete this.leftPromise;

        return this.setToRight(wanderer).then(function (right) {

            return leftPromise.then(function (left) {

                return evaluate(left, right);

            });

        });

    };

    var evaluate = function (left, right) {

        var result = {left: left, right: right};

        result.goTrash = [];
        result.goFusion = [];
        result.goQueue = [];

        if (left.gender === right.gender) {
            result.score = 10;
            result.goTrash.push(right);
            result.goTrash.push(left);
        } else {
            result.score = 100;
            result.goFusion.push({left: left, right: right});
        }

        return result;

    };

    boxPrototype.involve = function (wanderer) {
        wanderer.setMetrics(this.metrics.left, this.metrics.top, this.metrics.unit);
    };

    boxPrototype.setToLeft = function (wanderer) {

        var dur = 800;

        this.involve(wanderer);

        wanderer.setTransitionDuration(dur);

        wanderer.x = 1;
        wanderer.y = 1;

        return wait(10).then(function () {

            wanderer.locate();

            return wait(dur);

        }).then(function () {
            return wanderer;
        });

    };

    boxPrototype.setToRight = function (wanderer) {

        var dur = 800;

        this.involve(wanderer);

        wanderer.setTransitionDuration(dur);


        return wait(10).then(function () {

            wanderer.x = 3;
            wanderer.y = 1;
            wanderer.locate();

            return wait(dur);

        }).then(function () {

            return wanderer;

        });

    };

    boxPrototype.reset = function () {

        if (this.left != null) { this.left.remove(); }
        if (this.right != null) { this.right.remove(); }

        this.left = null;
        this.right = null;

    };

    return exports;

}());

// List of boms
window.domain = window.domain || {};
domain.level = domain.level || {};
domain.level.Map = (function () {
    'use strict';

    var exports = function (metrics) {
        var cells = this.cells = [];

        this.$dom = $(document.body);

        this.top = metrics.top;
        this.left = metrics.left;
        this.unit = metrics.unit;
    };

    /**
     *
     *
     * @return {Map}
     */
    exports.createFromBomList = function (bomList) {
        return new exports().loadFromBomList(bomList);
    };

    var mapPrototype = exports.prototype;

    /**
     *
     *
     * @return {Wanderer}
     */
    mapPrototype.createCellFromBom = function (bom) {
        return new domain.level.Wanderer(bom.x, bom.y, bom.gender, this.left, this.top, this.unit);
    };

    mapPrototype.empty = function () {
        this.cells.forEach(function (cell) { cell.remove(); });

        this.cells = [];
    };

    mapPrototype.loadFromBomList = function (bomList) {
        bomList.forEach(function (bom) {
            this.loadOne(this.createCellFromBom(bom));
        }, this);

        return this;
    };

    mapPrototype.loadList = function (list) {
        list.forEach(function (cell) { this.loadOne(cell); }, this);

        return this;
    };

    mapPrototype.loadOne = function (cell) {
        this.cells.push(cell);

        cell.locate();

        return this;
    };

    mapPrototype.appear = function (dom) {

        var promise = wait(10);

        this.cells.forEach(function (cell) {
            promise = promise.then(function () { return cell.appear(dom); });
        });

        return promise;
    };

    mapPrototype.commandAll = function (command, args) {

        this.cells.forEach(function (cell) {
            cell[command](args);
        });

    };

    // help item ?
    mapPrototype.allUp = function () { this.commandAll('up'); };
    mapPrototype.allDown = function () { this.commandAll('down'); };
    mapPrototype.allRight = function () { this.commandAll('right'); };
    mapPrototype.allLeft = function () { this.commandAll('left'); };

    mapPrototype.select = function (pos) {
        return this.cells.filter(function (cell) {
            return cell.x === pos.x && cell.y === pos.y;
        });
    };

    mapPrototype.find = function (pos) {
        var cand = this.select(pos);

        if (cand.length === 0) {
            return null;
        }

        return cand[0];
    };

    mapPrototype.selectRange = function (pos) {
        return this.cells.filter(function (cell) {
            return cell.x === pos.x && cell.y > pos.y;
        });
    };

    mapPrototype.filter = function (cells) {
        this.cells = this.cells.filter(function (cell) {
            return cells.indexOf(cell) < 0;
        });
    };

    return exports;

}());


// A bom
window.domain = window.domain || {};
domain.level = domain.level || {};
domain.level.Wanderer = (function () {
    'use strict';

    var exports = function (x, y, gender, left, top, unit) {
        this.x = x;
        this.y = y;
        this.width = Math.floor(unit / 2);
        this.gutter = Math.floor(unit / 4);

        this.$dom = $('<img />').css({
            'position': 'absolute',
            'width': this.width + 'px',
            'height': this.width + 'px',
        });

        this.setTransitionDuration(NUDUR);
        this.setGender(gender);
        this.setMetrics(left, top, unit);
    };

    var wPrototype = exports.prototype;

    wPrototype.setTransitionDuration = function (dur) {
        this.$dom.css('transition-duration', dur + 'ms');
    };

    wPrototype.setGender = function (gender) {
        this.gender = gender;

        if (gender === 'm') {
            return this.setMaleColor();
        } else if (gender === 'f') {
            return this.setFemaleColor();
        }
    };

    wPrototype.setFemaleColor = function () {
        this.$dom.attr('src', 'images/neef.svg');

        return this;
    };

    wPrototype.setMaleColor = function () {
        this.$dom.attr('src', 'images/nim.svg');

        return this;
    };

    wPrototype.appear = function (dom) {

        this.$dom.prependTo(dom || document.body).animation('bom-appear 500ms');

        return wait(40);
    };

    wPrototype.setMetrics = function (left, top, unit) {
        this.offsetX = left;
        this.offsetY = top;
        this.unit = unit;

        return this;
    };

    wPrototype.locate = function () {
        this.$dom.css({
            'top': this.offsetY + this.unit * this.y + this.gutter + 'px',
            'left': this.offsetX + this.unit * this.x + this.gutter + 'px',
        });
    };

    wPrototype.fadeAwayHappy = function () {
        this.$dom.css('transform', 'scale(2)');
        this.fadeAway();
    };

    wPrototype.fadeAwayUnhappy = function () {
        this.$dom.css('transform', 'rotate(45deg)');
        this.fadeAway();
    };

    wPrototype.fadeAway = function () {
        var that = this;

        setTimeout(function () {
            that.$dom.css('opacity', 0);

            setTimeout(function () {
                that.remove();
            }, 1000);
        }, 300);
    };

    wPrototype.remove = function () {
        this.$dom.remove();
    };

    wPrototype.move = function (x, y) {
        this.x += x;
        this.y += y;

        this.locate();
    };

    wPrototype.up = function () { this.move(0, -1); };
    wPrototype.down = function () { this.move(0, 1); };
    wPrototype.left = function () { this.move(-1, 0); };
    wPrototype.right = function () { this.move(1, 0); };

    return exports;
}());




// The ball you move, or swipe
window.domain = window.domain || {};
domain.level = domain.level || {};
domain.level.Ball = (function () {

    var exports = function (metrics) {
        this.x = 1;
        this.y = 1;
        this.MAX = 3;
        this.$dom = $('.circle')
            .css({width: metrics.unit + 'px', height: metrics.unit + 'px'});

        this.metrics = metrics;

        this.locate();
    };

    var ballPrototype = exports.prototype;

    ballPrototype.appear = function () {
        var dur = 800;

        this.$dom.css('visibility', 'visible');
        this.$dom.animation('ball-appear ' + dur + 'ms');

        return wait(dur);
    };

    ballPrototype.up = function () { this.setPos(this.posAhead('up')); };
    ballPrototype.down = function () { this.setPos(this.posAhead('down')); };
    ballPrototype.left = function () { this.setPos(this.posAhead('left')); };
    ballPrototype.right = function () { this.setPos(this.posAhead('right')); };

    ballPrototype.pos = function () {
        return {x: this.x, y: this.y};
    };

    ballPrototype.posAhead = function (dir) {
        switch (dir) {
            case 'up': return this.relativePos(0, -1);
            case 'down': return this.relativePos(0, 1);
            case 'left': return this.relativePos(-1, 0);
            case 'right': return this.relativePos(1, 0);
        }
    };

    ballPrototype.relativePos = function (x, y) {
        return {x: (this.x + x + this.MAX) % this.MAX, y: (this. y + y + this.MAX) % this.MAX};
    };

    ballPrototype.setPos = function (pos) {
        this.x = pos.x;
        this.y = pos.y;

        this.locate();
    };

    ballPrototype.locate = function () {
        this.$dom.css('top', this.metrics.top + this.y * this.metrics.unit + 'px');
        this.$dom.css('left', this.metrics.left + this.x * this.metrics.unit + 'px');
    };

    ballPrototype.refuseToMove = function (dir) {
        if (dir === 'up' || dir === 'down') {
            this.$dom.animation('ball-refuse-y 300ms');
        } else {
            this.$dom.animation('ball-refuse-x 300ms');
        }

        return wait(NUDUR);
    };

    return exports;
}());

window.domain = window.domain || {};
domain.level = domain.level || {};
domain.level.Field = (function () {

    var APPEAR_DUR = 200;

    var exports = function (metrics) {
        var gutter = 6;
        this.left = metrics.left - gutter;
        this.top = metrics.top - gutter;
        this.unit = metrics.unit;
        this.width = metrics.width + gutter * 2
    };

    var fPrototype = exports.prototype;

    fPrototype.appear = function () {
        var that = this;
        return loadImage('images/field.svg', 'field-grid', document.body).then(function ($img) {
            var dur = APPEAR_DUR;

            that.$dom = $img;

            $img.css('left', that.left + 'px');
            $img.css('top', that.top + 'px');
            $img.css('width', that.width + 'px');

            $img.animation('ball-appear ' + dur + 'ms');

            return wait(dur);
        });
    };

    return exports;
}());

</script>

<body>

<div id="main">

<button class="reset">reset</button>

<svg class="circle" width="100px" height="100px" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <circle cx="50" cy="50" r="49" stroke-width="2" stroke-opacity="0.4" stroke="#000000" fill="#909090" fill-opacity="0.5"/>
</svg>

<div class="wrapper"></div>

<div class="point" style="font-family: menlo; margin-left: 300px;">
m + f = <span class="mf">0</span><br />
f + m = <span class="fm">0</span><br />
m + m = <span class="mm">0</span><br />
f + f = <span class="ff">0</span><br />
Score = <span class="level-score">0</span><br />

</div>

</div>

</body>
</html>
